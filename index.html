<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- JSXをブラウザで解釈するためのBabel -->
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <!-- Lucide Icons -->
  <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-gray-50">
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect } = React;

    const App = () => {
      const [loading, setLoading] = useState(false);
      const [data, setData] = useState([]);
      const [message, setMessage] = useState('');
      const [error, setError] = useState(null);

      // データの初期読み込み
      useEffect(() => {
        loadData();
      }, []);

      const loadData = () => {
        setLoading(true);
        setError(null);

        // googleオブジェクトが存在するかチェック (GAS実行環境かどうかの確認)
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          google.script.run
            .withSuccessHandler((res) => {
              setData(res || []);
              setLoading(false);
            })
            .withFailureHandler((err) => {
              setError("データの読み込みに失敗しました: " + err.message);
              setLoading(false);
            })
            .getDashboardData();
        } else {
          // 開発環境やプレビュー用のダミーデータ（デバッグ用）
          console.warn("google.script.run is not defined. Using mock data.");
          setTimeout(() => {
            setData([
              { date: '2024-01-01', title: 'テスト求人A', impressions: 1000, clicks: 50, conv: 2 },
              { date: '2024-01-02', title: 'テスト求人B', impressions: 2000, clicks: 80, conv: 5 }
            ]);
            setLoading(false);
          }, 500);
        }
      };

      const handleFileUpload = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
          const csvText = event.target.result;
          setLoading(true);

          if (typeof google !== 'undefined' && google.script && google.script.run) {
            google.script.run
              .withSuccessHandler((res) => {
                if (res.success) {
                  setMessage(res.count + "件のデータを追加しました。");
                  loadData();
                } else {
                  setError(res.message);
                  setLoading(false);
                }
              })
              .withFailureHandler((err) => {
                setError("アップロードに失敗しました: " + err.message);
                setLoading(false);
              })
              .uploadCsvData(csvText);
          } else {
            setError("Google Apps Scriptの環境外ではアップロードできません。");
            setLoading(false);
          }
        };
        reader.readAsText(file);
      };

      const handlePdfExport = () => {
        setLoading(true);
        
        if (typeof google !== 'undefined' && google.script && google.script.run) {
          google.script.run
            .withSuccessHandler((url) => {
              setLoading(false);
              if (url) {
                window.open(url, '_blank');
              }
            })
            .withFailureHandler((err) => {
              setError("PDFの生成に失敗しました: " + err.message);
              setLoading(false);
            })
            .generateReportPdf();
        } else {
          setError("Google Apps Scriptの環境外ではPDF出力できません。");
          setLoading(false);
        }
      };

      return (
        <div className="max-w-6xl mx-auto p-8">
          <header className="flex justify-between items-center mb-10">
            <div>
              <h1 className="text-3xl font-bold text-slate-800">Indeed Organic Repo</h1>
              <p className="text-slate-500 text-sm">GAS & Spreadsheet Database</p>
            </div>
            <div className="flex gap-4">
              <label className="bg-white border border-slate-300 px-4 py-2 rounded-lg cursor-pointer hover:bg-slate-50 transition shadow-sm">
                CSVアップロード
                <input type="file" className="hidden" accept=".csv" onChange={handleFileUpload} />
              </label>
              <button 
                onClick={handlePdfExport}
                className="bg-emerald-600 text-white px-6 py-2 rounded-lg hover:bg-emerald-700 transition shadow-md flex items-center gap-2"
              >
                PDFレポート出力
              </button>
            </div>
          </header>

          {message && (
            <div className="bg-blue-50 text-blue-700 p-4 rounded-lg mb-6 flex items-center justify-between border border-blue-200">
              <span>{message}</span>
              <button onClick={() => setMessage('')} className="font-bold">×</button>
            </div>
          )}

          {error && (
            <div className="bg-red-50 text-red-700 p-4 rounded-lg mb-6 flex items-center justify-between border border-red-200">
              <span>{error}</span>
              <button onClick={() => setError(null)} className="font-bold">×</button>
            </div>
          )}

          {loading ? (
            <div className="flex justify-center items-center h-64">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600 mr-3"></div>
              <span className="text-slate-400 font-medium">処理中...</span>
            </div>
          ) : (
            <div className="grid grid-cols-1 gap-6">
              <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
                <div className="flex justify-between items-center mb-6">
                  <h2 className="text-xl font-bold text-slate-700">データ履歴</h2>
                  {typeof google === 'undefined' && (
                    <span className="text-xs bg-amber-100 text-amber-700 px-2 py-1 rounded">Preview Mode</span>
                  )}
                </div>
                <div className="overflow-x-auto">
                  <table className="w-full text-left text-sm">
                    <thead className="bg-slate-50 text-slate-500 font-bold uppercase">
                      <tr>
                        <th className="p-4">日付</th>
                        <th className="p-4">求人タイトル</th>
                        <th className="p-4 text-right">表示数</th>
                        <th className="p-4 text-right">クリック数</th>
                        <th className="p-4 text-right">応募数</th>
                      </tr>
                    </thead>
                    <tbody className="divide-y divide-slate-100">
                      {data.length === 0 ? (
                        <tr><td colSpan="5" className="p-10 text-center text-slate-400">データがありません。CSVをアップロードしてください。</td></tr>
                      ) : (
                        data.map((row, i) => (
                          <tr key={i} className="hover:bg-slate-50 transition-colors">
                            <td className="p-4 whitespace-nowrap text-slate-600">{row.date}</td>
                            <td className="p-4 font-medium text-slate-800">{row.title}</td>
                            <td className="p-4 text-right text-slate-600">{(row.impressions || 0).toLocaleString()}</td>
                            <td className="p-4 text-right text-slate-600">{(row.clicks || 0).toLocaleString()}</td>
                            <td className="p-4 text-right font-bold text-emerald-600">{(row.conv || 0).toLocaleString()}</td>
                          </tr>
                        ))
                      )}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
